{"version":3,"sources":["pb-gest-product.js"],"names":[],"mappings":"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","file":"pb-gest-product.js","sourcesContent":["/*! pb-gest-product 0.1.0 - Copyright 2015 Palmabit <hello@palmabit.com> (http://www.palmabit.com) */\n'use strict';\n\nclass ProductPresenter {\n  constructor (user) {\n    if (typeof user !== 'object') {\n      throw new TypeError('user must be an object');\n    }\n\n    this.user = user;\n  }\n\n  presentList (products) {\n    var i;\n\n    for (i = 0; i < products.length; i += 1) {\n      this.present(products[i]);\n    }\n\n    return products;\n  }\n\n  present(product) {\n    if (typeof product !== 'object') {\n      throw new TypeError('product must be an object');\n    }\n\n    if (!product.price) {\n      this.getPrice(product);\n    }\n\n    this.getQuantity(product);\n\n    return product;\n  }\n\n  getPrice(product) {\n    var i, user = this.user;\n    // var products = user.products || [];\n\n    // for (i = 0; i < products.length; i += 1) {\n    //   if (product && products[i].product === product._id) {\n    //     product.price = products[i].price_customer;\n    //     return product;\n    //   }\n    // }\n\n    if (this.getListPrice(product, user.list)) {            //priority 1\n      return product;\n    }\n    if (this.getListPrice(product, user.list_default)) {    //priority 2\n      return product;\n    }\n    if (this.getListPrice(product, user.list_active)) {     //priority 3\n      return product;\n    }\n\n    product.price = 0;\n    return product;\n  }\n\n  getListPrice(product, list) {\n    if (!Array.isArray(product.prices) || !list) {\n      return\n    }\n\n    for (var i = 0; i < product.prices.length; i += 1) {\n      if (product.prices[i].list === list._id) {\n        product.price = product.prices[i].price;\n        return product;\n      }\n    }\n  }\n\n  getQuantity(product) {\n    if (product.lots && product.lots.length > 0) {\n      product.quantity = 0;\n\n      product.lots.sort(function (a, b) {\n        return new Date(a.date) - new Date(b.date);\n      });\n\n      for (var i = 0; i < product.lots.length; i += 1) {\n        product.quantity += product.lots[i].quantity;\n      }\n    }\n\n    return product;\n  }\n}\n\n'use strict';\n\nclass ProductVatPresenter extends ProductPresenter {\n\n  present(product) {\n    super.present(product);\n    product.vat = this.getVat(product);\n    return product;\n  }\n\n  getVat(product) {\n    product.rate_reduced = product.rate_reduced || [];\n\n    if (product.rate_exemption) {             //product's vat exemption\n      return product.rate_exemption;\n    } else if (this.user.rate_exemption) {    //user's vat exemption\n      return this.user.rate_exemption;\n    } else if (this.user.rate) {              //user's vat reduced\n      return this.getVatReduced(product);\n    } else if (product.rate) {                //product's regular vat\n      return product.rate;\n    } else {                                  //default vat\n      return null;\n    }\n  }\n\n  getVatReduced(product) {\n    var i, reduced;\n\n    for (i = 0; i < product.rate_reduced.length; i += 1) {\n      reduced = product.rate_reduced[i];\n\n      if (reduced && reduced.name === this.user.rate) {\n        return reduced.vat;\n      }\n    }\n\n    //Product's regular vat is returned if reduced one is not found\n    return product.rate;\n  }\n}\n"]}