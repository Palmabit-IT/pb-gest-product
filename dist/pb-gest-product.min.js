/*! pb-gest-product 0.10.0 - Copyright 2016 Palmabit <hello@palmabit.com> (http://www.palmabit.com) */
"use strict";function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;h=j=i=void 0,d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;return void 0===i?void 0:i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return void 0;a=j,b=f,c=g,d=!0}},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),ItemFactory=function a(b){if(_classCallCheck(this,a),this.item=b,!b)throw new Error("item must be an object");return b.intangible?new ItemIntangible(b):new ItemLots(b)},ItemIntangible=function(){function a(b){_classCallCheck(this,a),b=b||{},b.quantity=1,this.item=b}return _createClass(a,[{key:"get",value:function(){return this.item}},{key:"set",value:function(a){this.item=a}},{key:"decrement",value:function(a){var b=this.item;return b.quantity=parseInt(b.quantity||0),b.quantity>0&&(b.quantity-=1),this}},{key:"increment",value:function(a){var b=this.item;return b.quantity=parseInt(b.quantity||0),b.quantity+=1,this}}]),a}(),ItemLots=function(){function a(b){_classCallCheck(this,a),b=b||{},b.lots=b.lots||[],this.item=b,b.lots.forEach(function(a,b){a.maxQty=a.quantity,a.quantity=0==b?1:0})}return _createClass(a,[{key:"get",value:function(){return this.item}},{key:"set",value:function(a){this.item=a}},{key:"decrement",value:function(a){var b=this.item;return 0===b.lots.length?this:(a=a||b.lots.length-1,b.lots[a].quantity=parseInt(b.lots[a].quantity||0),0>=a||b.lots[a].quantity<=0?b.lots[0].quantity>0&&(b.lots[0].quantity-=1):b.lots[a].quantity>0&&(b.lots[a].quantity-=1),this)}},{key:"increment",value:function(a){var b=this.item;return a=a||0,a>=b.lots.length?this:(b.lots[a].quantity=parseInt(b.lots[a].quantity||0),b.lots[a].maxQty=parseInt(b.lots[a].maxQty||0),b.lots[a].quantity+1>b.lots[a].maxQty?this.increment(a+1):(b.lots[a].quantity+=1,this))}}]),a}(),ItemManager=function(){function a(b){if(_classCallCheck(this,a),!b)throw new Error("item must be an object");b.quantity=b.quantity||0,this.item=b}return _createClass(a,[{key:"get",value:function(){return this.item}},{key:"set",value:function(a){this.item=a}},{key:"decrement",value:function(){var a=this.item;return a.quantity>0&&(a.quantity-=1),this}},{key:"increment",value:function(){var a=this.item;return(a.intangible||!a.maxQty||a.quantity<a.maxQty)&&(a.quantity+=1),this}}]),a}(),AbstractVersionable=function(){function a(b){_classCallCheck(this,a),this.obj=b}return _createClass(a,[{key:"hasVersion",value:function(a){return a&&"undefined"!=typeof a.version&&a.version}},{key:"hasVersions",value:function(){return this.obj&&Array.isArray(this.obj.versions)&&this.obj.versions.length>0}},{key:"findVersion",value:function(a){if(a&&this.hasVersions()){var b=!0,c=!1,d=void 0;try{for(var e,f=this.obj.versions[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;if(g&&g.name===a)return g}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}}}},{key:"isActive",value:function(a){return a&&a.active===!0}},{key:"isValid",value:function(a){var b,c,d=Date.now();return a?(a.start&&(b=new Date(a.start)),a.end&&(c=new Date(a.end)),(!b||d>=b)&&(!c||c>=d)):!1}},{key:"hasValidVersion",value:function(){if(!this.hasVersions())return!1;var a=!0,b=!1,c=void 0;try{for(var d,e=this.obj.versions[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value;if(this.isActive(f)&&this.isValid(f))return!0}}catch(g){b=!0,c=g}finally{try{!a&&e["return"]&&e["return"]()}finally{if(b)throw c}}return!1}}]),a}(),ProductItemConverter=function(){function a(){_classCallCheck(this,a),this.items=[],this.maxReached=[],this.products=[]}return _createClass(a,[{key:"add",value:function(a,b){this.products=[],this.items=b,this.maxReached=[];var c=!0,d=!1,e=void 0;try{for(var f,g=a[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;this._addProduct(h)}}catch(i){d=!0,e=i}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return this._merge()}},{key:"get",value:function(){return this.items}},{key:"getMaxReached",value:function(){return this.maxReached}},{key:"hasErrors",value:function(){return this.maxReached.length>0}},{key:"_addProduct",value:function(a){a&&(a.intangible===!0?this._addProductIntangible(a):this._addProductWithLots(a))}},{key:"_addProductWithLots",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=a.lots[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value,h=void 0;g.quantity&&0!==g.quantity&&(h=this._create(a,g),h.lots&&delete h.lots,this.products.push(h))}}catch(i){c=!0,d=i}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}}},{key:"_addProductIntangible",value:function(a){this.products.push(a)}},{key:"_create",value:function(a,b){return b=b||{},Object.assign({},a,{quantity:b.quantity,maxQty:b.maxQty,lot:{lot:b.lot,date:b.date,expiration:b.expiration},warehouse:b.warehouse})}},{key:"_merge",value:function(){var a=!0,b=!1,c=void 0;try{for(var d,e=this.products[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value,g=!1,h=!0,i=!1,j=void 0;try{for(var k,l=this.items[Symbol.iterator]();!(h=(k=l.next()).done);h=!0){var m=k.value;f._id===m._id&&(f.intangible===!0||!f.hasLots&&this._areDatesEqual(f.lot,m.lot)?(g=!0,this._incrementItems(f,m)):f.lot.lot===m.lot.lot&&this._areDatesEqual(f.lot,m.lot)&&(g=!0,this._incrementItems(f,m)))}}catch(n){i=!0,j=n}finally{try{!h&&l["return"]&&l["return"]()}finally{if(i)throw j}}g||this.items.push(f)}}catch(n){b=!0,c=n}finally{try{!a&&e["return"]&&e["return"]()}finally{if(b)throw c}}}},{key:"_incrementItems",value:function(a,b){a.intangible===!0||!b.maxQty||a.quantity+b.quantity<=b.maxQty?b.quantity=a.quantity+b.quantity:(b.quantity=b.maxQty,this.maxReached.push({description:b.description,lot:b.lot&&b.lot.lot?b.lot.lot:"-"}))}},{key:"_areDatesEqual",value:function(a,b){var c,d,e=a.expiration,f=b.expiration;return e||f?e&&f?(c=new Date(e),d=new Date(f),c.getFullYear()===d.getFullYear()&&c.getMonth()===d.getMonth()&&c.getDate()===d.getDate()):!1:!0}}]),a}(),ProductPresenter=function(){function a(b){_classCallCheck(this,a),this.user=b||{}}return _createClass(a,[{key:"presentList",value:function(a){var b;for(b=0;b<a.length;b+=1)this.present(a[b]);return a}},{key:"present",value:function(a){if("object"!=typeof a)throw new TypeError("product must be an object");return a.price||this.getPrice(a),this.getQuantity(a),a}},{key:"getPrice",value:function(a){var b=this.user;return this.getListPrice(a,b.list)?a:this.getListPrice(a,b.list_default)?a:this.getListPrice(a,b.list_active)?a:(a.price=0,a)}},{key:"getListPrice",value:function(a,b){if(Array.isArray(a.prices)&&b)for(var c=0;c<a.prices.length;c+=1)if(a.prices[c].list===b._id){var d=new ProductPrice(b,a.prices[c]);return a.price=d.getPrice(),a.discount=d.getDiscount()||this.getDiscountList(a.prices[c]),a.include_vat=!!b.include_vat,a}}},{key:"getDiscountList",value:function(a){if(this.user.list_discount){var b=new ProductPrice(this.user.list_discount,a);return b.getDiscount()}}},{key:"getQuantity",value:function(a){return a.intangible===!0?a:this.getQuantityFromLots(a)}},{key:"getQuantityFromLots",value:function(a){if(a.lots&&a.lots.length>0){a.quantity=0,a.lots.sort(function(a,b){return a.expiration&&b.expiration?new Date(a.expiration)-new Date(b.expiration):new Date(a.date)-new Date(b.date)});for(var b=0;b<a.lots.length;b+=1)a.quantity+=a.lots[b].quantity}return a}}]),a}(),ProductPrice=function(a){function b(a,c){if(_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,a),this.list=a,this.productPrice=c,"object"!=typeof a)throw new TypeError("list must be an object");if("object"!=typeof c)throw new TypeError("product price must be an object")}return _inherits(b,a),_createClass(b,[{key:"getPrice",value:function(){return this.productPriceHasVersion()?this._getPriceWithVersion():this._getPriceWithoutVersion()}},{key:"_getPriceWithVersion",value:function(){var a=this.findVersion(this.productPrice.version);return a&&this.isActive(a)&&this.isValid(a)?this.productPrice.price||0:0}},{key:"_getPriceWithoutVersion",value:function(){return this.isValid(this.list)||this.hasValidVersion()?this.productPrice.price||0:0}},{key:"productPriceHasVersion",value:function(){return"undefined"!=typeof this.productPrice.version&&this.productPrice.version}},{key:"getDiscount",value:function(){return this.productPriceHasVersion()?this._getDiscountWithVersion():this._getDiscountWithoutVersion()}},{key:"_getDiscountWithVersion",value:function(){var a=this.findVersion(this.productPrice.version);return a&&this.isActive(a)&&this.isValid(a)?a.discount:void 0}},{key:"_getDiscountWithoutVersion",value:function(){return this.isValid(this.list)||this.hasValidVersion()?this.list.discount:void 0}}]),b}(AbstractVersionable),ProductVatPresenter=function(a){function b(){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}return _inherits(b,a),_createClass(b,[{key:"present",value:function(a){return _get(Object.getPrototypeOf(b.prototype),"present",this).call(this,a),a.vat=this.getVat(a),a}},{key:"getVat",value:function(a){return a.rate_reduced=a.rate_reduced||[],a.rate_exemption?a.rate_exemption:this.user.rate_exemption?this.user.rate_exemption:this.user.rate?this.getVatReduced(a):a.rate?a.rate:this.user.rate_default||null}},{key:"getVatReduced",value:function(a){var b,c;for(b=0;b<a.rate_reduced.length;b+=1)if(c=a.rate_reduced[b],c&&c.name===this.user.rate)return c.vat;return a.rate}}]),b}(ProductPresenter);