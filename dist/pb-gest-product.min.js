/*! pb-gest-product 0.4.0 - Copyright 2015 Palmabit <hello@palmabit.com> (http://www.palmabit.com) */
"use strict";function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;h=j=i=void 0,d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;return void 0===i?void 0:i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return void 0;a=j,b=f,c=g,d=!0}},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),ItemFactory=function a(b){if(_classCallCheck(this,a),this.item=b,!b)throw new Error("item must be an object");return b.intangible?new ItemIntangible(b):b.hasLots?new ItemLots(b):new ItemNoLots(b)},ProductItemConverter=function(){function a(){_classCallCheck(this,a),this.items=[],this.maxReached=[],this.products=[]}return _createClass(a,[{key:"add",value:function(a,b){this.products=[],this.items=b,this.maxReached=[];var c=!0,d=!1,e=void 0;try{for(var f,g=a[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;this._addProduct(h)}}catch(i){d=!0,e=i}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return this._merge()}},{key:"get",value:function(){return this.items}},{key:"getMaxReached",value:function(){return this.maxReached}},{key:"hasErrors",value:function(){return this.maxReached.length>0}},{key:"_addProduct",value:function(a){a&&(a.hasLots===!0?this._addProductWithLots(a):this._addProductWithoutLots(a))}},{key:"_addProductWithLots",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=a.lots[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value,h=void 0;g.quantity&&0!==g.quantity&&(h=this._create(a,g),h.lots&&delete h.lots,this.products.push(h))}}catch(i){c=!0,d=i}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}}},{key:"_addProductWithoutLots",value:function(a){var b=a.intangible===!0?a:this._create(a,a.noLots);b.noLots&&delete b.noLots,this.products.push(b)}},{key:"_create",value:function(a,b){return b=b||{},Object.assign({},a,{quantity:b.quantity,maxQty:b.maxQty,lot:{lot:b.lot,date:b.date,expiration:b.expiration},warehouse:b.warehouse})}},{key:"_merge",value:function(){var a=!0,b=!1,c=void 0;try{for(var d,e=this.products[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value,g=!1,h=!0,i=!1,j=void 0;try{for(var k,l=this.items[Symbol.iterator]();!(h=(k=l.next()).done);h=!0){var m=k.value;f._id===m._id&&(f.hasLots!==!0?(g=!0,this._incrementItems(f,m)):f.lot&&m.lot&&f.lot.lot===m.lot.lot&&(g=!0,this._incrementItems(f,m)))}}catch(n){i=!0,j=n}finally{try{!h&&l["return"]&&l["return"]()}finally{if(i)throw j}}g||this.items.push(f)}}catch(n){b=!0,c=n}finally{try{!a&&e["return"]&&e["return"]()}finally{if(b)throw c}}}},{key:"_incrementItems",value:function(a,b){a.intangible===!0||a.quantity+b.quantity<=b.maxQty?b.quantity=a.quantity+b.quantity:(b.quantity=b.maxQty,this.maxReached.push({description:b.description,lot:b.lot&&b.lot.lot?b.lot.lot:"-"}))}}]),a}(),ProductPresenter=function(){function a(b){_classCallCheck(this,a),this.user=b||{}}return _createClass(a,[{key:"presentList",value:function(a){var b;for(b=0;b<a.length;b+=1)this.present(a[b]);return a}},{key:"present",value:function(a){if("object"!=typeof a)throw new TypeError("product must be an object");return a.price||this.getPrice(a),this.getQuantity(a),a}},{key:"getPrice",value:function(a){var b=this.user;return this.getListPrice(a,b.list)?a:this.getListPrice(a,b.list_default)?a:this.getListPrice(a,b.list_active)?a:(a.price=0,a)}},{key:"getListPrice",value:function(a,b){if(Array.isArray(a.prices)&&b)for(var c=0;c<a.prices.length;c+=1)if(a.prices[c].list===b._id)return a.price=a.prices[c].price,a}},{key:"getQuantity",value:function(a){return a.intangible===!0?a:this.getTangibleQuantity(a)}},{key:"getTangibleQuantity",value:function(a){return a.hasLots?this.getQuantityFromLots(a):a.noLots?(a.quantity=a.noLots.quantity,a):void 0}},{key:"getQuantityFromLots",value:function(a){if(a.lots&&a.lots.length>0){a.quantity=0,a.lots.sort(function(a,b){return new Date(a.expiration)-new Date(b.expiration)});for(var b=0;b<a.lots.length;b+=1)a.quantity+=a.lots[b].quantity}return a}}]),a}(),ProductVatPresenter=function(a){function b(){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}return _inherits(b,a),_createClass(b,[{key:"present",value:function(a){return _get(Object.getPrototypeOf(b.prototype),"present",this).call(this,a),a.vat=this.getVat(a),a}},{key:"getVat",value:function(a){return a.rate_reduced=a.rate_reduced||[],a.rate_exemption?a.rate_exemption:this.user.rate_exemption?this.user.rate_exemption:this.user.rate?this.getVatReduced(a):a.rate?a.rate:this.user.rate_default||null}},{key:"getVatReduced",value:function(a){var b,c;for(b=0;b<a.rate_reduced.length;b+=1)if(c=a.rate_reduced[b],c&&c.name===this.user.rate)return c.vat;return a.rate}}]),b}(ProductPresenter),ItemIntangible=function(){function a(b){_classCallCheck(this,a),b=b||{},b.quantity=1,this.item=b}return _createClass(a,[{key:"get",value:function(){return this.item}},{key:"set",value:function(a){this.item=a}},{key:"decrement",value:function(a){var b=this.item;return b.quantity=parseInt(b.quantity||0),b.quantity>0&&(b.quantity-=1),this}},{key:"increment",value:function(a){var b=this.item;return b.quantity=parseInt(b.quantity||0),b.quantity+=1,this}}]),a}(),ItemLots=function(){function a(b){_classCallCheck(this,a),b=b||{},b.lots=b.lots||[],this.item=b,b.lots.forEach(function(a,b){a.maxQty=a.quantity,a.quantity=0==b?1:0})}return _createClass(a,[{key:"get",value:function(){return this.item}},{key:"set",value:function(a){this.item=a}},{key:"decrement",value:function(a){var b=this.item;return 0===b.lots.length?this:(a=a||b.lots.length-1,b.lots[a].quantity=parseInt(b.lots[a].quantity||0),0>=a||b.lots[a].quantity<=0?b.lots[0].quantity>0&&(b.lots[0].quantity-=1):b.lots[a].quantity>0&&(b.lots[a].quantity-=1),this)}},{key:"increment",value:function(a){var b=this.item;return a=a||0,a>=b.lots.length?this:(b.lots[a].quantity=parseInt(b.lots[a].quantity||0),b.lots[a].maxQty=parseInt(b.lots[a].maxQty||0),b.lots[a].quantity+1>b.lots[a].maxQty?this.increment(a+1):(b.lots[a].quantity+=1,this))}}]),a}(),ItemNoLots=function(){function a(b){_classCallCheck(this,a),b=b||{},b.noLots=b.noLots||{},Object.assign(b.noLots,{maxQty:b.noLots.quantity,quantity:1}),this.item=b}return _createClass(a,[{key:"get",value:function(){return this.item}},{key:"set",value:function(a){this.item=a}},{key:"decrement",value:function(){var a=this.item;return a.noLots.quantity=parseInt(a.noLots.quantity||0),a.noLots.quantity>0&&(a.noLots.quantity-=1),this}},{key:"increment",value:function(){var a=this.item;return a.noLots.quantity=parseInt(a.noLots.quantity||0),a.noLots.maxQty=parseInt(a.noLots.maxQty||0),a.noLots.quantity+1<=a.noLots.maxQty&&(a.noLots.quantity+=1),this}}]),a}();